{"version":3,"file":"products-spec-popup.js","sources":["components/products-spec-popup/products-spec-popup.vue"],"sourcesContent":["<template>\n\t<up-popup :show=\"show\" closeable @close=\"handleClose\">\n\t\t<view class=\"spec-popup\">\n\t\t\t<view class=\"popup-header\">\n\t\t\t\t<image class=\"product-img\" :src=\"product.main_pic\" mode=\"aspectFill\"></image>\n\t\t\t\t<view class=\"product-info\">\n\t\t\t\t\t<view class=\"price\">¥{{finalPrice}}</view>\n\t\t\t\t\t<view class=\"selected\">已选：{{selectedSpec || \"请选择规格\"}}</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t<view class=\"spec-content\">\n\t\t\t\t<view class=\"spec-group\" v-for=\"group in specList\" :key=\"group.attr_id\">\n\t\t\t\t\t<view class=\"group-title\">{{group.attr_name}}</view>\n\t\t\t\t\t<view class=\"spec-items\" >\n\t\t\t\t\t\t<view \r\n\t\t\t\t\t\tclass=\"spec-item\" \r\n\t\t\t\t\t\tv-for=\"(item,index) in group.values\" \r\n\t\t\t\t\t\tkey=\"item.value_id\"\r\n\t\t\t\t\t\t:class=\"{active: selectedSpecs[group.attr_id] === item.value_id}\"\r\n\t\t\t\t\t\t@click=\"selectSpec(group.attr_id,item.value_id,item.value)\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t{{item.value}}\r\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t<view class=\"popup-footer\">\n\t\t\t\t<view class=\"quantity\">\n\t\t\t\t\t<text>数量</text>\n\t\t\t\t\t<view class=\"quantity-control\">\n\t\t\t\t\t\t<view class=\"minus\" @click=\"decrease\">-</view>\r\n\t\t\t\t\t\t<view class=\"count\">{{quantity}}</view>\r\n\t\t\t\t\t\t<view class=\"plus\" @click=\"increase\">+</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"confirm-ok\" @click=\"\">确定</view>\n\t\t\t\t<view class=\"confirm-btn\" @click=\"confirmSpec()\">加购</view>\n\t\t\t</view>\n\t\t</view>\n\t</up-popup>\n</template>\n\n<script setup lang=\"ts\">\r\nimport { watch, ref, reactive, computed } from \"vue\";\r\nimport {get,post} from \"@/utils/http\"\r\n\t\r\nconst props = defineProps<{show:boolean, product:any}>()\r\nconst emit = defineEmits([\"close\"])\r\n\r\n//获取商品规格\r\nwatch(() => props.show, (newVal) => {\n\t\tif (newVal) {\n\t\t\tgetSpec()\n\t\t}\n\t})\r\n\r\nconst specList = ref([])\r\nconst getSpec = async () => {\n\t\ttry {\n\t\t\tconst res : any = await get(\"/cart/getSpec\", { id: props.product.id })\r\n\t\t\tspecList.value = res || [] //返回结果一定是数组\r\n\t\t\tuni.__f__('log','at components/products-spec-popup/products-spec-popup.vue:62',\"商品规格\",specList.value)\n\t\t\tif (!res) {\n\t\t\t\thandleClose() //关闭弹窗\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tuni.navigateTo({\n\t\t\t\t\t\turl: \"/pages/login/login\"\n\t\t\t\t\t})\n\t\t\t\t}, 500)\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tuni.__f__('log','at components/products-spec-popup/products-spec-popup.vue:72',error)\n\t\t}\n}\r\n\r\nconst selectedSpecs = reactive<{ [key : string] : number }>({}) //{\"1\":5,\"2\":1} 存储选中的规格值id \r\nconst selectedTexts = reactive<{ [key : string] : string }>({}) //{\"1\":\"5kg\",\"2\":\"鸡肉味\"}\r\nconst selectedSpec = ref<string>(\"\") //已选规格字符串 如 2kg，鸡肉味\r\nconst selectSpec = (attr_id:number,value_id:number,value:string) =>{\r\n\tselectedSpecs[attr_id] = value_id\r\n\tselectedTexts[attr_id] = value\r\n\tselectedSpec.value = Object.values(selectedTexts).join(\"，\")\r\n}\r\n\r\nconst handleClose = () => {\n\t\temit(\"close\");\n\t\t//重置数据\n\t\tObject.keys(selectedSpecs).forEach(key => delete selectedSpecs[key]);\n\t\tObject.keys(selectedTexts).forEach(key => delete selectedTexts[key]);\n\t\tselectedSpec.value = \"\"\n}\r\n\r\n//商品数量\r\nconst quantity = ref(1)\r\nconst increase = () => {\n\t  quantity.value++\n\t}\nconst decrease = () => {\n\t  if (quantity.value > 1) {\n\t\t  quantity.value--\n\t}\n}\r\n\r\nconst finalPrice = computed(() =>{\r\n\tlet price : number = Number(props.product.price)\r\n\tif(specList.value.length){ //数组有数据再循环\r\n\t\tspecList.value.forEach(group => {\r\n\t\t\tconst selected = group.values.find(item => selectedSpecs[group.attr_id] === item.value_id);\r\n\t\t\tuni.__f__('log','at components/products-spec-popup/products-spec-popup.vue:109',\"选中的数据\", selected)\r\n\t\t\tif (selected?.multiple) {\r\n\t\t\t\tprice *= Number(selected.multiple)\r\n\t\t\t}\t\t\t\r\n\t\t})\r\n\t}\r\n\treturn price*quantity.value\r\n})\r\n\r\n//加入购物车\r\nconst confirmSpec = async () =>{\r\n\t//判断该商品的所有规格是否都有选择\r\n\t//every 用于检测数组中的左右元素是否都符合指定条件\r\n\tconst allSelected = specList.value.every(group => selectedSpecs[group.attr_id])\r\n\tif(!allSelected){\n\t\tuni.showToast({\n\t\t\ttitle:\"请选择完整规格\",\n\t\t\ticon:\"error\"\n\t\t})\n\t\treturn \n\t}\r\n\ttry {\r\n\t\t\tconst res=await post(\"/cart/addCart\",{\r\n\t\t\t\tproduct_id:props.product.id,\r\n\t\t\t\tname:props.product.name,\r\n\t\t\t\tprice:finalPrice.value,\r\n\t\t\t\tcount:quantity.value,\r\n\t\t\t\tspec:selectedSpec.value,\r\n\t\t\t\tmain_pic:props.product.main_pic\r\n\t\t\t})\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle:\"加购成功\",\r\n\t\t\t\ticon:\"success\"\r\n\t\t\t})\r\n\t\t\thandleClose()\r\n\t\t} catch (error) {\r\n\t\t\t//TODO handle the exception\r\n\t\t\tuni.__f__('error','at components/products-spec-popup/products-spec-popup.vue:146',error)\r\n\t\t}\r\n}\n</script>\n\n<style lang=\"scss\" scoped>\n\t.spec-popup {\n\t\tpadding: 30rpx;\n\n\t\t.popup-header {\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tmargin-bottom: 30rpx;\n\n\t\t\t.product-img {\n\t\t\t\twidth: 160rpx;\n\t\t\t\theight: 160rpx;\n\t\t\t\tborder-radius: 12rpx;\n\t\t\t\tmargin-right: 20rpx;\n\t\t\t}\n\n\t\t\t.product-info {\n\t\t\t\tflex: 1;\n\n\t\t\t\t.price {\n\t\t\t\t\tcolor: #ff4d4f;\n\t\t\t\t\tfont-size: 36rpx;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\tmargin-bottom: 10rpx;\n\t\t\t\t}\n\n\t\t\t\t.selected {\n\t\t\t\t\tcolor: #666;\n\t\t\t\t\tfont-size: 28rpx;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\t\t.spec-content {\n\t\t\tmax-height: 600rpx;\n\t\t\toverflow-y: auto;\n\n\t\t\t.spec-group {\n\t\t\t\tmargin-bottom: 30rpx;\n\n\t\t\t\t.group-title {\n\t\t\t\t\tfont-size: 28rpx;\n\t\t\t\t\tcolor: #333;\n\t\t\t\t\tmargin-bottom: 20rpx;\n\t\t\t\t}\n\n\t\t\t\t.spec-items {\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tflex-wrap: wrap;\n\t\t\t\t\tgap: 20rpx;\n\n\t\t\t\t\t.spec-item {\n\t\t\t\t\t\tpadding: 10rpx 30rpx;\n\t\t\t\t\t\tborder: 2rpx solid #ddd;\n\t\t\t\t\t\tborder-radius: 30rpx;\n\t\t\t\t\t\tfont-size: 26rpx;\n\t\t\t\t\t\tcolor: #666;\n\n\t\t\t\t\t\t&.active {\n\t\t\t\t\t\t\tcolor: #ffce2c;\n\t\t\t\t\t\t\tborder-color: $uni-color-primary;\n\t\t\t\t\t\t\tbackground-color: rgba(255, 206, 44, 0.1);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t.popup-footer {\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tjustify-content: space-between;\n\t\t\tmargin-top: 30rpx;\n\t\t\tpadding-top: 30rpx;\n\t\t\tborder-top: 2rpx solid #eee;\n\n\t\t\t.quantity {\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\n\t\t\t\ttext {\n\t\t\t\t\tmargin-right: 20rpx;\n\t\t\t\t\tfont-size: 28rpx;\n\t\t\t\t\tcolor: #333;\n\t\t\t\t}\n\n\t\t\t\t.quantity-control {\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\n\t\t\t\t\t.minus,\n\t\t\t\t\t.plus {\n\t\t\t\t\t\twidth: 60rpx;\n\t\t\t\t\t\theight: 60rpx;\n\t\t\t\t\t\tborder: 2rpx solid #ddd;\n\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\talign-items: center;\n\t\t\t\t\t\tjustify-content: center;\n\t\t\t\t\t\tfont-size: 32rpx;\n\t\t\t\t\t}\n\n\t\t\t\t\t.count {\n\t\t\t\t\t\twidth: 80rpx;\n\t\t\t\t\t\theight: 60rpx;\n\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\tborder-top: 2rpx solid #ddd;\n\t\t\t\t\t\tborder-bottom: 2rpx solid #ddd;\n\t\t\t\t\t\tline-height: 60rpx;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t.confirm-btn {\n\t\t\t\twidth: 220rpx;\n\t\t\t\theight: 80rpx;\n\t\t\t\tbackground-color: $uni-color-primary;\n\t\t\t\tcolor: #fff;\n\t\t\t\tborder-radius: 40rpx;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\tfont-size: 28rpx;\n\t\t\t}\n\t\t\t.confirm-ok{\n\t\t\t\twidth: 140rpx;\n\t\t\t\theight: 80rpx;\n\t\t\t\tborder: $uni-color-primary 1px solid;\n\t\t\t\tcolor: $uni-color-primary;\n\t\t\t\tborder-radius: 80rpx;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\tfont-size: 28rpx;\n\t\t\t}\n\t\t}\n\t}\n</style>"],"names":["watch","ref","get","uni","reactive","computed","post"],"mappings":"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"}